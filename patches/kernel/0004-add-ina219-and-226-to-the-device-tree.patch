From 364411de74820548f656203d7e886204ba83647d Mon Sep 17 00:00:00 2001
From: Iain Hunter <iain@hunterembedded.co.uk>
Date: Tue, 17 Aug 2021 17:30:31 +0100
Subject: [PATCH 4/4] add ina219 and 226 to the device tree

---
 .../arm/boot/dts/am335x-boneblack-common.dtsi | 34 ++++++++++++++++++-
 .../arm/boot/dts/am335x-bonegreen-common.dtsi | 29 ++++++++++++++++
 arch/arm/configs/tisdk_am335x-evm_defconfig   |  2 +-
 3 files changed, 63 insertions(+), 2 deletions(-)

diff --git a/arch/arm/boot/dts/am335x-boneblack-common.dtsi b/arch/arm/boot/dts/am335x-boneblack-common.dtsi
index aa051e4fb..f85cd5209 100644
--- a/arch/arm/boot/dts/am335x-boneblack-common.dtsi
+++ b/arch/arm/boot/dts/am335x-boneblack-common.dtsi
@@ -67,7 +67,15 @@
 		>;
 	};
     
-           /* Add SPI1 pins for Current Measurement cape */
+    /* Add I2C1 pins for Current Measurement cape */
+	i2c1_pins: pinmux_i2c1_pins {
+		pinctrl-single,pins = <
+			AM33XX_IOPAD(0x958, PIN_INPUT_PULLUP | MUX_MODE2)	/* spi0_d1.i2c1_sda */
+			AM33XX_IOPAD(0x95c, PIN_INPUT_PULLUP | MUX_MODE2)	/* spi0_cs0.i2c0_scl */
+		>;
+	};
+
+    /* Add SPI1 pins for Current Measurement cape */
 	spi1_pins: spi1_pins {
  		pinctrl-single,pins = <
 			AM33XX_IOPAD(0x990,PIN_INPUT_PULLUP | MUX_MODE3) /* mcasp0_aclkx.spi1_sclk */
@@ -127,6 +135,30 @@
 	system-power-controller;
 };
 
+/* Add support for the Current Measurement cape */
+&i2c1 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&i2c1_pins>;
+
+	status = "okay";
+	ina219@40{
+	compatible= "ti,ina219";
+	reg = <0x40>;
+	/* 3.3ohm fitted */ 
+	shunt-resistor = <3300000>;
+	};
+};
+
+&i2c2 {
+	status="okay";
+	ina226@40{
+	compatible= "ti,ina226";
+	reg = <0x40>;
+	/* 0.33ohm fitted */ 
+	shunt-resistor = <330000>;
+	};
+};
+
 &mcasp0	{
 	#sound-dai-cells = <0>;
 	pinctrl-names = "default";
diff --git a/arch/arm/boot/dts/am335x-bonegreen-common.dtsi b/arch/arm/boot/dts/am335x-bonegreen-common.dtsi
index 33160bd77..f0e647deb 100644
--- a/arch/arm/boot/dts/am335x-bonegreen-common.dtsi
+++ b/arch/arm/boot/dts/am335x-bonegreen-common.dtsi
@@ -29,6 +29,13 @@
 		>;
 	};
 
+    /* Add I2C1 pins for Current Measurement cape */
+	i2c1_pins: pinmux_i2c1_pins {
+		pinctrl-single,pins = <
+			AM33XX_IOPAD(0x958, PIN_INPUT_PULLUP | MUX_MODE2)	/* spi0_d1.i2c1_sda */
+			AM33XX_IOPAD(0x95c, PIN_INPUT_PULLUP | MUX_MODE2)	/* spi0_cs0.i2c0_scl */
+		>;
+	};
        /* Add SPI1 pins for Current Measurement cape */
 	spi1_pins: spi1_pins {
  		pinctrl-single,pins = <
@@ -51,6 +58,28 @@
 };
 
 /* Add support for the Current Measurement cape */
+&i2c1 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&i2c1_pins>;
+
+	status = "okay";
+	ina219@40{
+	compatible= "ti,ina219";
+	reg = <0x40>;
+	/* 3.3ohm fitted */ 
+	shunt-resistor = <3300000>;
+	};
+};
+
+&i2c2 {
+	status="okay";
+	ina226@40{
+	compatible= "ti,ina226";
+	reg = <0x40>;
+	/* 0.33ohm fitted */ 
+	shunt-resistor = <330000>;
+	};
+};
 
 &spi1{
 
diff --git a/arch/arm/configs/tisdk_am335x-evm_defconfig b/arch/arm/configs/tisdk_am335x-evm_defconfig
index ca7be739c..4ddc6a7f4 100644
--- a/arch/arm/configs/tisdk_am335x-evm_defconfig
+++ b/arch/arm/configs/tisdk_am335x-evm_defconfig
@@ -5463,7 +5463,7 @@ CONFIG_CPCAP_ADC=m
 # CONFIG_ENVELOPE_DETECTOR is not set
 # CONFIG_HI8435 is not set
 # CONFIG_HX711 is not set
-# CONFIG_INA2XX_ADC is not set
+CONFIG_INA2XX_ADC=y
 # CONFIG_LTC2471 is not set
 # CONFIG_LTC2485 is not set
 # CONFIG_LTC2497 is not set
-- 
2.25.1

